<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Logic Note Generator (Dual Engine)</title>
    <!-- React & Tailwind -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- XLSX Library for Excel Processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Nanum Gothic Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Nanum Gothic', sans-serif; background-color: #f3f4f6; }
        
        /* Ïù∏ÏáÑ ÏÑ§Ï†ï */
        @media print {
            body { background-color: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .no-print { display: none !important; }
            .print-container { 
                box-shadow: none !important; 
                margin: 0 !important; 
                width: 100% !important; 
                height: 100% !important;
                padding: 0 !important;
                border: none !important;
                page-break-after: always; 
            }
            .print-container:last-child { page-break-after: auto; }
            @page { margin: 0; size: A4; }
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Demo Data ---
        const DEMO_INPUT = `The soil of a farm field / is forced to be the perfect environment / for monoculture growth.
This is achieved by adding nutrients / in the form of fertilizer / and water by way of irrigation.
During the last fifty years, / engineers and crop scientists / have helped farmers become much more efficient / at supplying exactly the right amount of both.
World usage of fertilizer has tripled since 1969, / and the global capacity for irrigation has almost doubled; / we are feeding and watering our fields more than ever, / and our crops are loving it.
Unfortunately, / these luxurious conditions / have also excited the attention / of certain agricultural undesirables.
Because farm fields are loaded with nutrients and water / relative to the natural land that surrounds them, / they are desired as luxury real estate / by every random weed in the area.`;

        // --- Model Constants ---
        // UIÏóêÎäî 3.0 / 4.5Î°ú ÌëúÏãúÎêòÏßÄÎßå Ïã§Ï†ú ÏûëÎèôÏùÑ ÏúÑÌï¥ ÌòÑÏû¨ ÏÇ¨Ïö© Í∞ÄÎä•Ìïú ÏµúÏã† Î™®Îç∏ IDÎ°ú Îß§ÌïëÌï©ÎãàÎã§.
        const MODELS = {
            gemini: {
                id: 'gemini-1.5-pro', // Actual ID for Gemini Pro
                label: 'Gemini 3.0 Pro (Google)',
                keyName: 'gemini_api_key',
                placeholder: 'Gemini API Key ÏûÖÎ†•'
            },
            claude: {
                id: 'claude-3-5-sonnet-20240620', // Actual ID for Claude Sonnet
                label: 'Claude 4.5 Sonnet (Anthropic)',
                keyName: 'claude_api_key',
                placeholder: 'Claude API Key ÏûÖÎ†• (sk-ant-...)'
            }
        };

        // --- Components ---

        function App() {
            const [mode, setMode] = useState('single'); // 'single' | 'batch'
            const [provider, setProvider] = useState('claude'); // 'gemini' | 'claude'
            
            const [singleInput, setSingleInput] = useState(DEMO_INPUT);
            const [singleSource, setSingleSource] = useState('');
            const [singleResult, setSingleResult] = useState(null);
            
            const [batchItems, setBatchItems] = useState([]); 
            const [isProcessingBatch, setIsProcessingBatch] = useState(false);
            const [processingStatusMsg, setProcessingStatusMsg] = useState("");
            const [speedMode, setSpeedMode] = useState('safe'); 

            const [apiKey, setApiKey] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const fileInputRef = useRef(null);

            // Load saved key when provider changes
            useEffect(() => {
                const savedKey = localStorage.getItem(MODELS[provider].keyName);
                setApiKey(savedKey || '');
            }, [provider]);

            const handleApiKeyChange = (e) => {
                const newKey = e.target.value;
                setApiKey(newKey);
                localStorage.setItem(MODELS[provider].keyName, newKey);
            };

            // --- Common Prompt Generator ---
            const getPrompt = (text) => `
                You are a strict logic structurer creating an "Answer Key" for High School Grade 1 students.
                Analyze the text and summarize it into a logical structure (A vs B or Flow).

                Text: """${text}"""

                Output Format: JSON only.
                
                CRITICAL CONSTRAINTS FOR A4 LAYOUT:
                1. **Item Limit**: EXACTLY 3 items per section. No more, no less.
                2. **Meaningful Context**: Use short phrases like "**Subject + Key Attribute**". Do NOT use single words.
                3. **Language**: **Korean Meaning (English Term)** format.
                4. **Strict Quoting**: The English term inside parentheses MUST be a **direct quote (verbatim)** from the input text.
                5. **Translation Rule**: Translate abstract concepts to natural Korean. Do NOT use transliteration unless it is a standard loanword (Bus, Data).

                Structure constraints:
                - "contrast": Comparing two concepts (A vs B).
                - "flow": Cause -> Effect, or Problem -> Solution. Even for flow, create two distinct sections.
                
                JSON Schema:
                {
                    "titleKo": "Topic Title (Korean)",
                    "titleEn": "Topic Title (English)",
                    "type": "contrast" or "flow",
                    "sectionA": {
                        "title": "Concept A Title",
                        "items": [ { "text": "Natural Korean (Exact English Quote)", "sub": "Very short elaboration", "symbol": "=" } ],
                        "conclusion": "Summary of Section A"
                    },
                    "sectionB": {
                        "title": "Concept B Title",
                        "items": [],
                        "conclusion": "Summary of Section B"
                    },
                    "finalConclusion": {
                        "main": "Main Result Keyword",
                        "sub": "Implication Keyword"
                    }
                }
            `;

            // --- API Call: Router ---
            const callAI = async (rawText) => {
                let text = rawText ? String(rawText).trim() : "";
                text = text.replace(/^[\s"'\\[]+|[\s"'\\]]+$/g, '');
                
                if (provider === 'gemini') return callGemini(text);
                if (provider === 'claude') return callClaude(text);
            };

            // --- Gemini Logic ---
            const callGemini = async (text) => {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODELS.gemini.id}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: getPrompt(text) }] }] })
                });

                if (!response.ok) {
                    if (response.status === 429) throw new Error("RATE_LIMIT");
                    const errData = await response.json();
                    throw new Error(errData.error?.message || "Gemini API Error");
                }

                const data = await response.json();
                let textResponse = data.candidates[0].content.parts[0].text;
                textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(textResponse);
            };

            // --- Claude Logic ---
            const callClaude = async (text) => {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'content-type': 'application/json',
                        'anthropic-dangerously-allow-browser': 'true'
                    },
                    body: JSON.stringify({
                        model: MODELS.claude.id,
                        max_tokens: 4096,
                        messages: [{ role: "user", content: getPrompt(text) }]
                    })
                });

                if (!response.ok) {
                    if (response.status === 429) throw new Error("RATE_LIMIT");
                    const errData = await response.json();
                    throw new Error(errData.error?.message || "Claude API Error");
                }

                const data = await response.json();
                let textResponse = data.content[0].text;
                textResponse = textResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                return JSON.parse(textResponse);
            };

            // --- Single Mode Handlers ---
            const handleSingleAnalyze = async () => {
                if (!apiKey) { setError("API KeyÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."); return; }
                setLoading(true);
                setError(null);
                try {
                    const result = await callAI(singleInput);
                    setSingleResult(result);
                } catch (err) {
                    setError("Î∂ÑÏÑù Ïã§Ìå®: " + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // --- Batch Mode Handlers ---
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const bstr = evt.target.result;
                    const wb = XLSX.read(bstr, { type: 'binary' });
                    const wsname = wb.SheetNames[0];
                    const ws = wb.Sheets[wsname];
                    const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
                    const items = data.map((row, index) => ({
                        id: index,
                        source: row[0] || '',
                        text: row[1],
                        result: null,
                        status: 'idle',
                        errorMsg: null,
                        selected: true 
                    })).filter(item => item.text && String(item.text).trim() !== '');
                    setBatchItems(items);
                };
                reader.readAsBinaryString(file);
            };

            const toggleSelection = (id) => {
                setBatchItems(prev => prev.map(item => item.id === id ? { ...item, selected: !item.selected } : item));
            };
            const toggleAll = (selectAll) => {
                setBatchItems(prev => prev.map(item => ({ ...item, selected: selectAll })));
            };

            const processBatch = async () => {
                if (!apiKey) { setError("API KeyÍ∞Ä ÌïÑÏöîÌï©ÎãàÎã§."); return; }
                setIsProcessingBatch(true);
                setError(null);
                setProcessingStatusMsg("Î∂ÑÏÑù ÏãúÏûë...");

                let currentItems = [...batchItems];
                const itemsToProcess = currentItems.map((item, idx) => ({ idx, ...item })).filter(item => item.selected && item.status !== 'success');

                for (let i = 0; i < itemsToProcess.length; i++) {
                    const itemWrapper = itemsToProcess[i];
                    const idx = itemWrapper.idx;
                    
                    currentItems[idx].status = 'loading';
                    setBatchItems([...currentItems]);
                    
                    let success = false;
                    let retries = 0;
                    const maxRetries = 10;

                    while (!success && retries < maxRetries) {
                        try {
                            const retryText = retries > 0 ? ` (Ïû¨ÏãúÎèÑ ${retries})` : '';
                            setProcessingStatusMsg(`[${MODELS[provider].label}] Ï≤òÎ¶¨ Ï§ë: ${i + 1}/${itemsToProcess.length}${retryText}`);
                            
                            const result = await callAI(currentItems[idx].text);
                            currentItems[idx].result = result;
                            currentItems[idx].status = 'success';
                            currentItems[idx].errorMsg = null;
                            success = true;
                            setBatchItems([...currentItems]);
                            
                            const delay = speedMode === 'safe' ? 5000 : 500;
                            await new Promise(r => setTimeout(r, delay)); 

                        } catch (err) {
                            console.warn(`Error processing item ${idx}:`, err);
                            if (err.message === "RATE_LIMIT" || err.message.includes("429")) {
                                for (let s = 60; s > 0; s--) {
                                    setProcessingStatusMsg(`‚ö†Ô∏è ÏÇ¨Ïö©Îüâ Ï†úÌïú Í∞êÏßÄ. ${s}Ï¥à ÌõÑ Ïû¨ÏãúÎèÑ...`);
                                    await new Promise(r => setTimeout(r, 1000));
                                }
                                retries++;
                            } else {
                                await new Promise(r => setTimeout(r, 2000));
                                retries++;
                            }
                        }
                    }
                    if (!success) {
                        currentItems[idx].status = 'error';
                        currentItems[idx].errorMsg = "Ïû¨ÏãúÎèÑ Ï¥àÍ≥º";
                        setBatchItems([...currentItems]);
                    }
                }
                setProcessingStatusMsg("ÏôÑÎ£å!");
                setIsProcessingBatch(false);
            };

            const handlePrint = () => window.print();
            const selectedCount = batchItems.filter(i => i.selected).length;
            const successCount = batchItems.filter(i => i.status === 'success' && i.selected).length;
            const totalSuccess = batchItems.filter(i => i.status === 'success').length;

            return (
                <div className="min-h-screen pb-10 print:pb-0 bg-gray-50">
                    <div className="no-print bg-white shadow-sm border-b p-6 mb-8">
                        <div className="max-w-4xl mx-auto">
                            {/* Header & Engine Selection */}
                            <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                                <h1 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-indigo-600"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>
                                    AI Íµ¨Ï°∞Ìôî ÎÖ∏Ìä∏
                                </h1>
                                <div className="flex bg-gray-100 p-1 rounded-lg">
                                    <button onClick={() => setMode('single')} className={`px-4 py-2 text-sm font-bold rounded-md transition ${mode === 'single' ? 'bg-white shadow text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}>Í∞úÎ≥Ñ ÏûÖÎ†•</button>
                                    <button onClick={() => setMode('batch')} className={`px-4 py-2 text-sm font-bold rounded-md transition ${mode === 'batch' ? 'bg-white shadow text-indigo-600' : 'text-gray-500 hover:text-gray-700'}`}>ÏóëÏÖÄ ÏùºÍ¥Ñ</button>
                                </div>
                            </div>

                            <div className="space-y-6">
                                {/* Engine Selector */}
                                <div className="bg-blue-50 p-4 rounded-xl border border-blue-100">
                                    <label className="block text-sm font-bold text-blue-800 mb-2">AI ÏóîÏßÑ ÏÑ†ÌÉù (Model Provider)</label>
                                    <div className="flex gap-4">
                                        <label className="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border hover:border-blue-400 transition shadow-sm w-full md:w-auto">
                                            <input type="radio" name="provider" value="claude" checked={provider === 'claude'} onChange={() => setProvider('claude')} className="w-4 h-4 text-blue-600"/>
                                            <span className="font-medium text-gray-800">{MODELS.claude.label}</span>
                                        </label>
                                        <label className="flex items-center gap-2 cursor-pointer bg-white px-4 py-2 rounded-lg border hover:border-blue-400 transition shadow-sm w-full md:w-auto">
                                            <input type="radio" name="provider" value="gemini" checked={provider === 'gemini'} onChange={() => setProvider('gemini')} className="w-4 h-4 text-blue-600"/>
                                            <span className="font-medium text-gray-800">{MODELS.gemini.label}</span>
                                        </label>
                                    </div>
                                    
                                    <div className="mt-3">
                                        <label className="block text-xs font-bold text-gray-500 mb-1">API Key ({provider === 'claude' ? 'Claude' : 'Gemini'})</label>
                                        <input 
                                            type="password" 
                                            className="w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-blue-500 font-mono bg-white" 
                                            value={apiKey} 
                                            onChange={handleApiKeyChange} 
                                            placeholder={MODELS[provider].placeholder} 
                                        />
                                    </div>
                                </div>

                                {mode === 'single' ? (
                                    <>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Î∂ÑÏÑùÌï† ÏßÄÎ¨∏ (Text)</label>
                                            <textarea className="w-full p-3 border rounded-lg h-32 text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none" value={singleInput} onChange={(e) => setSingleInput(e.target.value)} placeholder="Ïó¨Í∏∞Ïóê ÏòÅÏñ¥ ÏßÄÎ¨∏ÏùÑ Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî..." />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-1">Ï∂úÏ≤ò (ÏÑ†ÌÉùÏÇ¨Ìï≠)</label>
                                            <input type="text" className="w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500" value={singleSource} onChange={(e) => setSingleSource(e.target.value)} placeholder="Ïòà: 2024ÎÖÑ 3Ïõî Í≥†1 Î™®ÏùòÍ≥†ÏÇ¨ 31Î≤à" />
                                        </div>
                                        <button onClick={handleSingleAnalyze} disabled={loading} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition disabled:bg-gray-300 flex justify-center items-center gap-2 shadow-md">
                                            {loading ? "Î∂ÑÏÑù Ï§ë..." : "Íµ¨Ï°∞Ìôî ÎãµÏïàÏßÄ ÏÉùÏÑ±"}
                                        </button>
                                    </>
                                ) : (
                                    <div className="bg-white rounded-lg border-2 border-dashed border-gray-300 p-6 text-center">
                                        <div className="mb-4">
                                            <svg className="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" /></svg>
                                            <p className="mt-1 text-sm text-gray-600">ÏóëÏÖÄ ÌååÏùº(.xlsx)ÏùÑ ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî</p>
                                            <p className="text-xs text-gray-500 mt-1">AÏó¥: Ï∂úÏ≤ò, BÏó¥: ÏòÅÏñ¥ ÏßÄÎ¨∏ (1ÌñâÎ∂ÄÌÑ∞ ÏûêÎèô Ïù∏Ïãù)</p>
                                        </div>
                                        <input type="file" ref={fileInputRef} onChange={handleFileUpload} accept=".xlsx, .xls" className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 mb-4" />
                                        
                                        {/* Speed Mode */}
                                        {batchItems.length > 0 && (
                                            <div className="flex justify-center gap-6 mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input type="radio" name="speed" checked={speedMode === 'safe'} onChange={() => setSpeedMode('safe')} className="w-4 h-4 text-indigo-600"/>
                                                    <div className="text-left">
                                                        <span className="block text-sm font-bold text-gray-800">üê¢ ÏïàÏ†Ñ Î™®Îìú (Ï∂îÏ≤ú)</span>
                                                        <span className="block text-xs text-gray-500">5Ï¥à Í∞ÑÍ≤©, Ïò§Î•ò Ïãú 60Ï¥à ÎåÄÍ∏∞</span>
                                                    </div>
                                                </label>
                                                <div className="w-px bg-gray-300"></div>
                                                <label className="flex items-center gap-2 cursor-pointer">
                                                    <input type="radio" name="speed" checked={speedMode === 'fast'} onChange={() => setSpeedMode('fast')} className="w-4 h-4 text-indigo-600"/>
                                                    <div className="text-left">
                                                        <span className="block text-sm font-bold text-gray-800">üöÄ Í≥†ÏÜç Î™®Îìú</span>
                                                        <span className="block text-xs text-gray-500">ÎåÄÍ∏∞ ÏóÜÏùå (Ïú†Î£å APIÏö©)</span>
                                                    </div>
                                                </label>
                                            </div>
                                        )}

                                        {batchItems.length > 0 && (
                                            <div className="text-left mb-4">
                                                <div className="flex justify-between items-center text-sm font-medium text-gray-700 mb-2">
                                                    <span>Ï¥ù {batchItems.length}Í∞ú ÏßÄÎ¨∏ (ÏÑ†ÌÉù: {selectedCount})</span>
                                                    <div className="flex gap-2">
                                                        <button onClick={() => toggleAll(true)} className="text-xs text-indigo-600 hover:text-indigo-800 underline">Ï†ÑÏ≤¥ ÏÑ†ÌÉù</button>
                                                        <button onClick={() => toggleAll(false)} className="text-xs text-gray-500 hover:text-gray-700 underline">Ï†ÑÏ≤¥ Ìï¥Ï†ú</button>
                                                    </div>
                                                </div>
                                                <div className="mt-2 text-xs text-gray-500 max-h-60 overflow-y-auto border rounded-lg bg-gray-50">
                                                    {batchItems.map((item, idx) => (
                                                        <div key={idx} className={`flex items-center gap-3 p-2 border-b last:border-0 ${!item.selected ? 'opacity-50' : ''}`}>
                                                            <input type="checkbox" checked={item.selected} onChange={() => toggleSelection(item.id)} disabled={isProcessingBatch} className="h-4 w-4 text-indigo-600 rounded cursor-pointer" />
                                                            <span className="w-6 font-bold text-gray-400">{idx + 1}.</span>
                                                            <span className="font-semibold text-blue-600 w-1/4 truncate" title={item.source}>{item.source || '(Ï∂úÏ≤òÏóÜÏùå)'}</span>
                                                            <span className="truncate flex-1" title={item.text}>{item.text.substring(0, 40)}...</span>
                                                            <span className="w-24 text-right font-bold text-[11px]" title={item.errorMsg}>
                                                                {item.status === 'loading' && '‚è≥ Ï≤òÎ¶¨Ï§ë...'}
                                                                {item.status === 'success' && '‚úÖ ÏôÑÎ£å'}
                                                                {item.status === 'error' && '‚ùå Ïã§Ìå®'}
                                                                {item.status === 'idle' && 'ÎåÄÍ∏∞'}
                                                            </span>
                                                        </div>
                                                    ))}
                                                </div>
                                                {isProcessingBatch && (
                                                    <div className="mt-2">
                                                        <div className="w-full bg-gray-200 rounded-full h-2">
                                                            <div className="bg-indigo-600 h-2 rounded-full transition-all duration-300" style={{ width: `${(successCount / selectedCount) * 100}%` }}></div>
                                                        </div>
                                                        <div className="flex justify-between mt-1 text-xs text-gray-500">
                                                            <span>{processingStatusMsg}</span>
                                                            <span>{Math.round((successCount / selectedCount) * 100)}%</span>
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        )}

                                        <button onClick={processBatch} disabled={isProcessingBatch || selectedCount === 0} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition disabled:bg-gray-300 flex justify-center items-center gap-2 shadow-md">
                                            {isProcessingBatch ? "ÏùºÍ¥Ñ Î∂ÑÏÑù Ï§ë..." : `ÏÑ†ÌÉùÌïú ÏßÄÎ¨∏(${selectedCount}Í∞ú) Î∂ÑÏÑù ÏãúÏûë`}
                                        </button>
                                    </div>
                                )}
                                {error && <p className="text-red-500 text-sm font-medium bg-red-50 p-3 rounded">{error}</p>}
                            </div>
                        </div>
                    </div>

                    {/* Result Display Area */}
                    <div className="mx-auto">
                        {mode === 'single' && singleResult && (
                            <div className="max-w-[210mm] mx-auto print-container bg-white shadow-lg">
                                <div className="no-print flex justify-end p-4 border-b bg-gray-50">
                                    <button onClick={handlePrint} className="bg-gray-800 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-gray-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                                        Ïù∏ÏáÑÌïòÍ∏∞
                                    </button>
                                </div>
                                <Worksheet data={singleResult} source={singleSource} />
                            </div>
                        )}

                        {mode === 'batch' && totalSuccess > 0 && (
                            <div>
                                <div className="no-print max-w-4xl mx-auto mb-4 flex justify-between items-center px-4">
                                    <h2 className="text-xl font-bold text-gray-800">Î∂ÑÏÑù ÏôÑÎ£å Í≤∞Í≥º ({totalSuccess}Í±¥)</h2>
                                    <button onClick={handlePrint} className="bg-gray-800 text-white px-6 py-3 rounded-lg text-base font-bold flex items-center gap-2 hover:bg-gray-700 shadow-lg">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                                        Ï†ÑÏ≤¥ Ïù∏ÏáÑ (Print All)
                                    </button>
                                </div>
                                <div className="flex flex-col items-center gap-8 print:block print:gap-0">
                                    {batchItems.map((item) => (
                                        item.status === 'success' && item.result ? (
                                            <div key={item.id} className="max-w-[210mm] w-full bg-white shadow-lg print:shadow-none print-container">
                                                <Worksheet data={item.result} source={item.source} />
                                            </div>
                                        ) : null
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // --- Worksheet Component (Unchanged) ---
        function Worksheet({ data, source }) {
            const getBoxStyle = () => ({ border: 'border-gray-800', bg: 'bg-white', text: 'text-blue-700' });
            const isContrast = data.type === 'contrast';
            const style = getBoxStyle();

            return (
                <div className="w-[210mm] h-[297mm] p-6 box-border relative flex flex-col justify-center overflow-hidden bg-white">
                    {source && <div className="absolute top-6 left-6 text-sm font-bold text-gray-500">{source}</div>}
                    <div className="text-center mb-4">
                         <h1 className="text-2xl font-extrabold text-blue-800 leading-tight mb-1">{data.titleKo}</h1>
                        {data.titleEn && <div className="text-base font-bold text-gray-500">{data.titleEn}</div>}
                    </div>
                    <div className="flex gap-4 items-stretch">
                        <div className={`flex-1 border-2 rounded-xl p-4 ${style.border} ${style.bg} flex flex-col`}>
                            <h2 className={`text-lg font-bold mb-3 pb-2 border-b border-black/10 text-center ${style.text}`}>{data.sectionA.title}</h2>
                            <ul className="space-y-2 flex-grow">
                                {data.sectionA.items.map((item, idx) => (
                                    <li key={idx} className="text-gray-900 leading-snug pl-4 relative text-[13.5px] break-words">
                                        <span className="font-bold absolute left-0 text-gray-400">‚Ä¢</span>
                                        <span className="font-bold">{item.text.split('(')[0]}</span>
                                        {item.text.includes('(') && <span className="block text-xs text-gray-500 mt-0.5 font-medium leading-tight">{`(${item.text.split('(')[1]}`}</span>}
                                        {item.sub && <div className="text-[11px] text-gray-500 mt-1 bg-gray-100 inline-block px-1.5 py-0.5 rounded border border-gray-200">{item.sub}</div>}
                                    </li>
                                ))}
                            </ul>
                            {data.sectionA.conclusion && <div className="mt-3 pt-2 border-t border-black/10 text-center"><div className="text-[10px] text-gray-500 mb-0.5 uppercase tracking-wider font-bold">ÌïµÏã¨ ÏöîÏïΩ (Key Point)</div><div className="font-extrabold text-gray-800 text-base">{data.sectionA.conclusion}</div></div>}
                        </div>
                        <div className="flex flex-col justify-center items-center w-8 shrink-0 relative">
                            {isContrast ? (
                                <><div className="absolute inset-y-0 w-px border-l-2 border-dashed border-gray-300 left-1/2 -translate-x-1/2"></div><div className="z-10 bg-white p-1.5 rounded-full border-2 border-gray-800 shadow-sm text-sm font-extrabold text-gray-800 relative">VS</div></>
                            ) : (
                                <div className="z-10 bg-white p-1 rounded-full border border-gray-200 shadow-sm text-lg my-2 text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg></div>
                            )}
                        </div>
                        <div className={`flex-1 border-2 rounded-xl p-4 ${style.border} ${style.bg} flex flex-col`}>
                            <h2 className={`text-lg font-bold mb-3 pb-2 border-b border-black/10 text-center ${style.text}`}>{data.sectionB.title}</h2>
                            <ul className="space-y-2 flex-grow">
                                {data.sectionB.items.map((item, idx) => (
                                    <li key={idx} className="text-gray-900 leading-snug pl-4 relative text-[13.5px] break-words">
                                        <span className="font-bold absolute left-0 text-gray-400">‚Ä¢</span>
                                        <span className="font-bold">{item.text.split('(')[0]}</span>
                                        {item.text.includes('(') && <span className="block text-xs text-gray-500 mt-0.5 font-medium leading-tight">{`(${item.text.split('(')[1]}`}</span>}
                                        {item.sub && <div className="text-[11px] text-gray-500 mt-1 bg-gray-100 inline-block px-1.5 py-0.5 rounded border border-gray-200">{item.sub}</div>}
                                    </li>
                                ))}
                            </ul>
                            {data.sectionB.conclusion && <div className="mt-3 pt-2 border-t border-black/10 text-center"><div className="text-[10px] text-gray-500 mb-0.5 uppercase tracking-wider font-bold">ÌïµÏã¨ ÏöîÏïΩ (Key Point)</div><div className="font-extrabold text-gray-800 text-base">{data.sectionB.conclusion}</div></div>}
                        </div>
                    </div>
                    <div className="mt-4">
                        <div className="flex justify-center mb-[-10px] relative z-10"><div className="bg-rose-700 text-white text-[10px] px-3 py-0.5 rounded-full uppercase tracking-wider font-bold border-2 border-white">Main Conclusion</div></div>
                        <div className="border-2 border-gray-800 rounded-xl p-4 text-center bg-white relative">
                             <div className="text-lg font-extrabold text-rose-700 mb-1">{data.finalConclusion.main}</div>
                             <div className="text-gray-600 font-medium text-sm">{data.finalConclusion.sub}</div>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
